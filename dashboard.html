<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Booking Dashboard</title>
  <style>
    body { font-family: Arial; margin:20px; }
    .status { font-size:20px; margin-bottom:10px; }
    .status span { font-weight:700; }
    table { width:100%; border-collapse: collapse; margin-top:20px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#f3f3f3; }
    .calendar-container { margin-top:20px; }
    .calendar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; }
    .calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:5px; }
    .cell { border:1px solid #333; border-radius:6px; min-height:80px; padding:4px; font-size:12px; }
    .dayname { font-weight:600; opacity:0.7; text-align:center; }
    .today { border:2px solid blue; }
    .booking { margin-top:2px; padding:2px; border-radius:4px; font-size:10px; color:white; text-align:center; }
    button { padding:4px 8px; margin:2px; }
  </style>
</head>
<body>
  <h1>Booking Dashboard</h1>
  <div class="status">System Status: <span id="status">OFF</span></div>

  <h2>Current Bookings</h2>
  <table>
    <thead><tr><th>Name</th><th>Start</th><th>End</th><th>Experiment</th></tr></thead>
    <tbody id="bookings-tbody"></tbody>
  </table>

  <div class="calendar-container">
    <div class="calendar-header">
      <button id="prev-month">◀ Previous Month</button>
      <h2 id="month-name">January 2026</h2>
      <button id="next-month">Next Month ▶</button>
    </div>
    <div class="calendar" id="calendar"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // -------------------------
    // Firebase config
    // -------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDVaYntloZAK1akrJ-tfzun57hd_3bOfsg",
      authDomain: "book1-bc265.firebaseapp.com",
      databaseURL: "https://book1-bc265-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "book1-bc265",
      storageBucket: "book1-bc265.appspot.com",
      messagingSenderId: "82320132624",
      appId: "1:82320132624:web:044b4034fbcef85ed55895"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const bookingsRef = ref(db, 'bookings');
    const statusRef = ref(db, 'menlo_status');

    const tbody = document.getElementById('bookings-tbody');
    const statusEl = document.getElementById('status');
    const calendarEl = document.getElementById('calendar');
    const monthNameEl = document.getElementById('month-name');

    let currentOffset = 0; // month offset from today
    let bookingsData = [];

    // -------------------------
    // Helpers
    // -------------------------
    function nameColor(name) {
      let hash = 0;
      for (let i=0;i<name.length;i++) hash = name.charCodeAt(i) + ((hash << 5)-hash);
      let c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
      return "#" + "00000".substring(0, 6-c.length) + c;
    }

    function renderTable(bookings) {
      tbody.innerHTML = "";
      bookings.forEach(b => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${b.Name}</td><td>${b["Start Date"]}</td><td>${b["End Date"]}</td><td>${b["Experiment Type"]}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderCalendar(bookings) {
      calendarEl.innerHTML = "";
      const today = new Date();
      const year = today.getFullYear() + Math.floor((today.getMonth()+currentOffset)/12);
      const month = (today.getMonth()+currentOffset)%12;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month+1, 0);

      // display month name
      const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      monthNameEl.innerText = `${monthNames[month]} ${year}`;

      // start from Sunday of the first week
      const startDay = new Date(firstDay);
      startDay.setDate(startDay.getDate() - startDay.getDay());

      // end on Saturday of the last week
      const endDay = new Date(lastDay);
      endDay.setDate(endDay.getDate() + (6 - endDay.getDay()));

      // weekday headers
      ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d=>{
        const headerCell = document.createElement('div');
        headerCell.className="cell dayname";
        headerCell.innerText=d;
        calendarEl.appendChild(headerCell);
      });

      for(let d=new Date(startDay); d <= endDay; d.setDate(d.getDate()+1)) {
        const cell = document.createElement('div');
        cell.className="cell";
        if(d.toDateString()===today.toDateString() && currentOffset===0) cell.classList.add('today');
        cell.innerHTML = `<div>${d.getDate()}</div>`;

        bookings.forEach(b => {
          const sd = new Date(b["Start Date"]);
          const ed = new Date(b["End Date"]);
          const current = new Date(d.getFullYear(), d.getMonth(), d.getDate());
          const start = new Date(sd.getFullYear(), sd.getMonth(), sd.getDate());
          const end = new Date(ed.getFullYear(), ed.getMonth(), ed.getDate());
          if(current >= start && current <= end) {
            const div = document.createElement('div');
            div.className='booking';
            div.style.background=nameColor(b.Name);
            div.innerText = b.Name;
            cell.appendChild(div);
          }
        });

        calendarEl.appendChild(cell);
      }
    }

    // -------------------------
    // Month navigation
    // -------------------------
    document.getElementById("prev-month").addEventListener("click", ()=>{
      currentOffset -= 1;
      renderCalendar(bookingsData);
    });
    document.getElementById("next-month").addEventListener("click", ()=>{
      currentOffset += 1;
      renderCalendar(bookingsData);
    });

    // -------------------------
    // Firebase listeners
    // -------------------------
    onValue(bookingsRef, (snapshot)=>{
      const data = snapshot.val();
      if(!data) return;
      bookingsData = Object.values(data);
      renderTable(bookingsData);
      renderCalendar(bookingsData);
    });

    onValue(statusRef, (snapshot)=>{
      const val = snapshot.val() || "OFF";
      statusEl.innerText = val;
      statusEl.style.color = val==="ON"?"green":"red";
    });
  </script>
</body>
</html>
